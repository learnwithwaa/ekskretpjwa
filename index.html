<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ExcretiX Game</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#cfe3cf;
      --card:#e8f6e6;
      --text:#1f3b28;
      --primary:#2f5a3a;
      --primary-2:#3f7a4f;
      --outline:rgba(47,90,58,.28);
      --shadow:0 16px 36px rgba(15,35,22,.15);
      --shadow-soft:0 10px 22px rgba(15,35,22,.12);
      --r-xl:28px;
      --r-lg:22px;
      --container:1120px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      overflow-x:hidden;
    }
    .container{width:min(var(--container),calc(100% - 48px));margin:0 auto}
    .text-center{text-align:center}
    .flex{display:flex;gap:12px}
    .flex-between{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .muted{color:rgba(31,59,40,.65);font-weight:800}

    /* cloud */
    .cloud{
      position:absolute;width:190px;height:62px;background:rgba(255,255,255,.85);
      border-radius:999px;filter:drop-shadow(0 10px 14px rgba(0,0,0,.08));opacity:.9;
    }
    .cloud:before,.cloud:after{content:"";position:absolute;background:rgba(255,255,255,.85);border-radius:999px}
    .cloud:before{width:78px;height:78px;left:26px;top:-32px}
    .cloud:after{width:92px;height:92px;right:22px;top:-42px}

    /* buttons */
    .btn{
      border:0;cursor:pointer;font-weight:900;letter-spacing:.4px;
      transition:transform .18s ease, box-shadow .18s ease, background .18s ease, opacity .18s ease;
      user-select:none;
    }
    .btn:active{transform:translateY(1px)}
    .btn-pill{padding:12px 22px;border-radius:999px}
    .btn-primary{background:var(--primary);color:#fff;box-shadow:0 10px 18px rgba(47,90,58,.22)}
    .btn-primary:hover{background:var(--primary-2);transform:translateY(-1px)}
    .btn-ghost{background:transparent;color:var(--text);border:2px solid var(--outline)}
    .btn-ghost:hover{background:rgba(255,255,255,.35);box-shadow:var(--shadow-soft);transform:translateY(-1px)}
    .btn-danger{background:#ef4444;color:#fff;box-shadow:0 10px 18px rgba(239,68,68,.18)}
    .btn-danger:hover{background:#dc2626;transform:translateY(-1px)}

    /* HOME */
    .home{
      min-height:100vh;position:relative;display:flex;align-items:center;padding:36px 0;
      background:
        radial-gradient(1200px 600px at 30% 10%, rgba(255,255,255,.40), transparent 60%),
        radial-gradient(900px 600px at 90% 20%, rgba(255,255,255,.28), transparent 55%),
        var(--bg);
    }

    /* (REVISI) biar posisi gak kejauhan + lebih tengah */
    .hero{
      display:grid;
      grid-template-columns:max-content max-content;
      justify-content: center;
      gap:50px;
      align-items:center;
      transform: translateX(25px);
    }

    .kicker{
      font-weight:900;color:rgba(31,59,40,.75);letter-spacing:.8px;
      text-transform:uppercase;font-size:14px;margin-bottom:10px;
    }
    .hero h1{
      font-size:clamp(52px,6vw,92px);
      line-height:.95;font-weight:900;letter-spacing:-1px;margin-bottom:18px;
    }
    .start{
      display:inline-flex;align-items:center;justify-content:center;
      padding:10px 28px;border-radius:999px;border:3px solid rgba(47,90,58,.22);
      background:rgba(255,255,255,.20);color:rgba(31,59,40,.65);
      font-weight:900;letter-spacing:2px;text-transform:uppercase;font-size:14px;
      box-shadow:0 16px 30px rgba(15,35,22,.10);
    }
    .start:hover{background:rgba(255,255,255,.32);transform:translateY(-1px)}

    /* map illus */
    .hero-right{
        display:flex;
        justify-content:flex-start
    } /* (REVISI) cover ke tengah */

    /* (REVISI) COVER BULAT + LEBIH KECIL */
    .cover-wrap{
      width:360px;
      height:360px;
      border-radius:50%;
      overflow:hidden;
      box-shadow:var(--shadow);
      background:rgba(255,255,255,.18);
      border:2px solid rgba(47,90,58,.14);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .cover-img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    /* Pages */
    .page{
      min-height:100vh;padding:34px 0 44px;
      background:
        radial-gradient(900px 500px at 20% 0%, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(800px 540px at 90% 20%, rgba(255,255,255,.25), transparent 58%),
        var(--bg);
    }
    .page-title{
      text-align:center;font-weight:900;letter-spacing:.8px;color:rgba(31,59,40,.80);
      margin:8px 0 26px;font-size:clamp(34px,3.5vw,52px);text-transform:uppercase;
    }

    /* MENU cards */
    .menu-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:22px}
    .menu-card{
      background:var(--card);border-radius:var(--r-xl);box-shadow:var(--shadow-soft);
      border:2px solid rgba(47,90,58,.10);
      padding:26px 18px;min-height:320px;
      display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;
      transition:transform .18s ease, box-shadow .18s ease;
      cursor:pointer;
    }
    .menu-card:hover{transform:translateY(-6px);box-shadow:var(--shadow)}
    .menu-card h3{font-size:26px;font-weight:900;margin-bottom:10px;color:rgba(31,59,40,.92)}
    .menu-card p{color:rgba(31,59,40,.62);font-weight:800;max-width:240px;line-height:1.6;margin-bottom:18px}
    .menu-card .cta{
      background:var(--primary);color:#fff;padding:10px 18px;border-radius:14px;
      font-weight:900;letter-spacing:.6px;box-shadow:0 10px 16px rgba(47,90,58,.18);
    }
    .menu-card .cta:hover{background:var(--primary-2);transform:translateY(-1px)}

    .home-back{display:flex;justify-content:center;margin-top:28px}
    .btn-home{
      padding:12px 34px;border-radius:999px;background:rgba(255,255,255,.22);
      border:3px solid rgba(47,90,58,.22);color:rgba(31,59,40,.62);
      font-weight:900;letter-spacing:3px;text-transform:uppercase;box-shadow:0 18px 30px rgba(15,35,22,.10);
    }
    .btn-home:hover{background:rgba(255,255,255,.32);transform:translateY(-1px)}

    .panel{
      background:rgba(255,255,255,.40);
      border:2px solid rgba(47,90,58,.14);
      border-radius:var(--r-xl);
      box-shadow:var(--shadow-soft);
      padding:26px;
      backdrop-filter:blur(6px);
    }
    .panel h2{margin-bottom:10px;font-weight:900;letter-spacing:.6px;color:rgba(31,59,40,.92);font-size:34px}
    .info-box{
      background:rgba(47,90,58,.10);
      border:2px solid rgba(47,90,58,.14);
      border-radius:var(--r-lg);
      padding:14px 16px;
      color:rgba(31,59,40,.82);
      margin-top:14px;
      font-weight:900;
    }
    .hint{
      margin-top:10px;
      border-radius:18px;
      padding:12px 14px;
      font-weight:900;
      display:none;
    }
    .hint.ok{display:block;background:rgba(34,197,94,.15);border:2px solid rgba(34,197,94,.25);color:rgba(21,128,61,.95)}
    .hint.bad{display:block;background:rgba(239,68,68,.12);border:2px solid rgba(239,68,68,.22);color:rgba(185,28,28,.95)}

    label{font-weight:900;color:rgba(31,59,40,.85)}
    select, input, textarea{
      width:100%;margin-top:8px;padding:12px 14px;border-radius:16px;
      border:2px solid rgba(47,90,58,.18);
      background:rgba(255,255,255,.60);
      outline:none;font-size:16px;color:rgba(31,59,40,.92);
      font-family:inherit;
    }
    select:focus, input:focus, textarea:focus{
      border-color:rgba(47,90,58,.35);
      box-shadow:0 0 0 5px rgba(47,90,58,.12);
    }
    .form-group{margin-bottom:16px}

    /* table */
    table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:18px}
    th,td{padding:14px 12px;border-bottom:1px solid rgba(31,59,40,.12)}
    th{background:rgba(47,90,58,.88);color:#fff;font-weight:900;letter-spacing:.4px;text-align:left}
    tbody tr{background:rgba(255,255,255,.55)}
    tbody tr:nth-child(even){background:rgba(255,255,255,.42)}

    /* toast */
    .toast{
      position:fixed;top:18px;left:50%;transform:translateX(-50%);
      background:rgba(47,90,58,.92);color:#fff;padding:14px 18px;border-radius:14px;
      box-shadow:0 14px 24px rgba(0,0,0,.18);z-index:9999;font-weight:900;letter-spacing:.3px;
      text-align:center;min-width:min(520px,calc(100% - 40px));
    }

    /* MODAL LOGIN GURU */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(15, 35, 22, .35);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 18px;
    }
    .modal{
      width: min(520px, 100%);
      background: rgba(255,255,255,.78);
      border: 2px solid rgba(47,90,58,.18);
      border-radius: var(--r-xl);
      box-shadow: var(--shadow);
      padding: 22px 22px 18px;
    }
    .modal .icon{
      font-size: 54px;
      text-align: center;
      margin-bottom: 8px;
    }
    .modal .title{
      text-align: center;
      font-weight: 900;
      letter-spacing: .6px;
      color: rgba(31,59,40,.92);
      font-size: 28px;
      margin-bottom: 6px;
    }

    /* Gambar peta */
    .map-image-wrap{
      margin-top:16px;
      border-radius:22px;
      overflow:hidden;
      border:2px solid rgba(47,90,58,.18);
      box-shadow:var(--shadow);
      background:rgba(255,255,255,.28);
    }
    .map-image{
      width:100%;
      height:auto;
      display:block;
    }

    /* responsive */
    @media (max-width:980px){
      .hero{grid-template-columns:1fr}
      .hero-right{justify-content:center}
      .menu-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    @media (max-width:560px){
      .menu-grid{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <div id="app"></div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // 1) KONFIGURASI GAME (EDIT DI SINI)
    const GROUP_OPTIONS = Array.from({length: 10}, (_, i) => `Kelompok ${i+1}`);

    // 0) GOOGLE SHEET (LOG JAWABAN)
    const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbxmDhNbYhyGd-qWlQ82gwx68HvedcjychM_Lk87Oyt_6TuMxJComXcDfxqcLJc2d92C/exec";
    const SHEET_TOKEN   = "EXCRETIX_TOKEN_123";

        // ‚úÖ (REVISI) KEYWORDS PER TEXTBOX (A/B/C) DI DALAM TOPIK
  const TOPIC_RULES = {
    ginjal: {
      boxes: {
        A: { minMatch: 3, keywords: [
          "filtrasi",
          "penyaringan",
          "reabsorpsi",
          "penyerapan kembali",
          "augmentasi",
          "sekresi",
        ] },
        B: { minMatch: 3, keywords: [
          "darah disaring",
          "penyaringan darah",
          "darah masuk ke ginjal lalu disaring",
          "penyerapan kembali",
          "zat penting diambil lagi",
          "air dan zat yang masih dibutuhkan",
          "zat sisa dikeluarkan",
          "pembuangan zat sisa",
          "pembuangan akhir",
        ] },
        C: { minMatch: 2, keywords: [
          "glomelurus",
          "tubulus ginjal",
          "gangguan tubulus ginjal",
          "reabsorpsi tidak optimal",
          "korteks mengandung glomelurus dan tubulus awal",
          "korteks menentukan kualitas filtrasi",
          "medula dan duktur kolektivus",
          "kepekatan urin",
          "warna urin",
          "kerusakan",
          "pembentukan urin",
          "kesimbangan cairan tubuh",
          "gejala edema",
        ] },
      }
    },
    hati: {
      boxes: {
        A: { minMatch: 4, keywords: [
          "mengeluarkan",
          "zat sisa",
          "detoksifikasi",
          "menetralkan racun",
          "mengubah sisa metabolisme protein",
          "keseimbangan cairan",
          "zat terlarut",
          "dalam darah",
        ] },
        B: { minMatch: 5, keywords: [
          "hati", 
          "ginjal",
          "amonia",
          "urea",
          "nefron",
          "urin",
          "sistem ekskresi",
          "pembuangan zat sisa",
          "metabolisme protein",
          "menyaring darah",
          "pembentukan urin",
          "amonia menjadi urea",
          "BAK",
          "buang air kecil",
          "gangguan", 
          "penyaringan",
          "iritasi saluran kemih",
        ] },
        C: { minMatch: 9, keywords: [
          "siklusurea",
          "detoksifikasi",
          "bilirubin",
          "toksin",
          "amonia",
          "hepatosit",
          "ikterus",
          "ginjal",
          "urea",
          "empedu"
        ] },
      }
    },
    paru: {
      boxes: {
        A: { minMatch: 4, keywords: [
          "Alveolus", 
          "sistem ekskresi", 
          "pertukaran gas", 
          "karbon dioksida", 
          "uap air", 
          "difusi", 
          "kapiler darah", 
          "ekspirasi", 
          "keseimbangan asam-basa", 
          "gangguan paru-paru",
          "dinding tipis",
          "sesak napas",
          "mudah lelah",
          "keseimbangan asam-basa",
          "bronkitis",
          "emfisema",
        ] },
      }
    },
    kulit: {
      boxes: {
        A: { minMatch: 7, keywords: [
          "lapisan",
          "dermis",
          "kelenjar keringat",
          "kelenjar ekrin",
          "keringat dialirkan ke pori-pori epidermis",
          "epidermis",
          "suhu tubuh",
          "kelenjar keringat rusak",
        ] },
        B: { minMatch: 5, keywords: [
          "bakteri",
          "zat volatil",
          "ekrin dan apokrin",
          "kelenjar apokrin",
          "aktivitas hormon",
          "makanan",
          "stres",
          "peningkatan hormon",
          "metabolisme tubuh",
        ] },
        C: { minMatch: 1, keywords: [
        "ekskresi",
        "kelenjar",
        "epiderm",
        "kulit",
        "dermis",
        "keringat",
        "laktat",
        "suhutub",
        "suhutubuh",
        "natrium",
        "urea",
        ] },
      }
    }
  };

  // ‚úÖ (REVISI) 3 textbox per topik: A/B/C
  const TOPIC_CASES = {
    ginjal: [
      { id: "A", title: "Textbox A" },
      { id: "B", title: "Textbox B" },
      { id: "C", title: "Textbox C" },
    ],
    hati: [
      { id: "A", title: "Textbox A" },
      { id: "B", title: "Textbox B" },
      { id: "C", title: "Textbox C" },
    ],
    paru: [
      { id: "A", title: "Textbox A" },
    ],
    kulit: [
      { id: "A", title: "Textbox A" },
      { id: "B", title: "Textbox B" },
      { id: "C", title: "Textbox C" },
    ],
  };


    // ‚úÖ (BARU) 1 topik boleh dipilih max 3 kelompok
    const MAX_GROUPS_PER_TOPIC = 3;

    const TOPIC_GROUP_LIMITS = {
      ginjal: 3,
      hati: 3,
      paru: 1,   // üî• paru cuma boleh 1 kelompok
      kulit: 3
    };

    const TEACHER_USERNAME = 'minwaa';
    const TEACHER_PASSWORD = 'bismillahlancar';
    const TEACHER_SESSION_KEY = 'excretix_teacher_session';

    const STORE_GAME_KEY = 'excretix_v2_game';

    const STORE_SELECTED_GROUP_KEY = 'excretix_selected_group';

    const STORE_RESET_AT_KEY = 'excretix_reset_at';


    let currentPage = 'home';
    let selectedTopic = null;
    let selectedBox = null; // ‚úÖ (BARU) A/B/C yang dipilih kelompok (1 saja)
    let selectedGroup = null; // ‚úÖ kelompok yg sedang mengerjakan
    let topicStartTime = null;

    let rankFrom = 'menu';          // 'menu' atau 'answer'
    let isAdmin = false;

    let gameState = { groups: {} };

    // ‚úÖ (BARU) aksi setelah lihat rank (lanjut kasus / selesai)
    let afterRankAction = null;

    const topics = [
      { id: 'ginjal', name: 'Ginjal', icon: 'ü´ò' },
      { id: 'hati', name: 'Hati', icon: 'ü´Ä' },
      { id: 'paru', name: 'Paru-paru', icon: 'ü´Å' },
      { id: 'kulit', name: 'Kulit', icon: 'ü§≤' }
    ];

    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function showToast(message){
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = message;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), 1600);
    }

    function normalizeText(text){
      return String(text || '')
        .toLowerCase()
        .normalize('NFKD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9\s]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    }

    function checkGlobalReset(resetAt){
      const last = Number(localStorage.getItem(STORE_RESET_AT_KEY) || 0);

      if(Number(resetAt || 0) > last){
        // hapus data lokal
        localStorage.removeItem(STORE_GAME_KEY);
        localStorage.removeItem(STORE_SELECTED_GROUP_KEY);

        // simpan resetAt terbaru
        localStorage.setItem(STORE_RESET_AT_KEY, String(resetAt));

        // reset state runtime
        gameState = { groups:{} };
        selectedGroup = null;
        selectedTopic = null;
        selectedBox = null;

        showToast("üîÑ Game direset oleh guru");
          currentPage = 'role';
          renderPage();
          return true;
      }
          return false;
    }

    async function sendToSheet(payload){
      try{
        const form = new URLSearchParams();
        for (const [k,v] of Object.entries(payload)){
          form.append(k, typeof v === 'object' ? JSON.stringify(v) : String(v));
        }

        const res = await fetch(SHEET_API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
          body: form.toString(),
        });

        const text = await res.text();
        try { return JSON.parse(text); } catch { return { ok:true, raw:text }; }

      } catch(err){
        console.warn("Gagal kirim ke Sheet:", err);
        return { ok:false, error:String(err) };
      }
    }

    async function syncFromSheet(){
      try{
        const url = `${SHEET_API_URL}?token=${encodeURIComponent(SHEET_TOKEN)}`;
        const res = await fetch(url);
        const json = await res.json();
        if(!json.ok) throw new Error(json.error || "sync failed");

        const resetAt = Number(json.resetAt || 0);

        // kalau reset terjadi, langsung stop (karena navigateTo udah jalan)
        if(checkGlobalReset(resetAt)) return;

        const rows = (json.rows || []).filter(r => {
          const ts = Number(r.timestampMs || 0) || new Date(r.timestamp).getTime() || 0;
          return ts >= resetAt;
        });

        const newState = { groups:{} };

        for(const r of rows){
          const group = r.group || "";
          const topicId = (r.topicId || "").toLowerCase();
          const boxId = r.boxId || "";
          const correct = String(r.correct).toLowerCase() === "true";
          const attempts = Number(r.attempts || 0);
          const timeTakenMs = Number(r.timeTakenMs || 0);
          const answer = r.answer || "";

          if(!group) continue;

          if(!newState.groups[group]){
            newState.groups[group] = {
              picked_topic: topicId || null,
              topics: {},
              total_correct: 0,
              total_time: 0,
              last_updated: Date.now()
            };
          }

          const g = newState.groups[group];

          if(topicId){
            g.picked_topic = g.picked_topic || topicId;
            if(!g.topics[topicId]) g.topics[topicId] = { cases:{}, picked_box: null };
            if(boxId) g.topics[topicId].picked_box = g.topics[topicId].picked_box || boxId;

            if(boxId){
              g.topics[topicId].cases[boxId] = {
                correct,
                attempts,
                answer,
                time_taken: timeTakenMs,
                timestamp: Date.now(),
                startedAt: Date.now()
              };
            }
          }

          const topic = g.picked_topic;
          if(topic){
            const cases = g.topics?.[topic]?.cases || {};
            g.total_correct = Object.values(cases).filter(x=>x.correct).length;
            g.total_time = Object.values(cases).reduce((s,x)=>s+(x.time_taken||0),0);
          }
        }

        gameState = newState;
        saveGame();

        if (currentPage === 'ranking' || currentPage === 'admin' || currentPage === 'menu') {
          renderPage();
        }

      }catch(err){
        console.warn(err);
        showToast("‚ùå Sync gagal: " + err.message);
      }
    }

    // ‚úÖ (REVISI) evaluasi kata kunci sekarang PER TEXTBOX (A/B/C)
  function evaluateAnswer(topicId, boxId, answer){
    const rule = TOPIC_RULES?.[topicId]?.boxes?.[boxId];
    if(!rule) return { ok:false, matched:[], needed:1, minMatch:1 };

    const norm = normalizeText(answer);
    const matched = [];

    for(const kw of (rule.keywords || [])){
      const needle = normalizeText(kw);
      if(needle && norm.includes(needle)){
        matched.push(kw);
      }
    }

    const minMatch = rule.minMatch || 1;
    return { ok: matched.length >= minMatch, matched, needed: Math.max(0, minMatch - matched.length), minMatch };
  }


    function formatMs(ms){
      const s = Math.round(ms/1000);
      const m = Math.floor(s/60);
      const r = s % 60;
      return m>0 ? `${m}m ${r}s` : `${r}s`;
    }

    // ‚úÖ (BARU) hitung berapa kelompok yang sudah memilih topik tertentu
    function countGroupsPickingTopic(topicId){
      let n = 0;
      for(const g of Object.values(gameState.groups || {})){
        if(g?.picked_topic === topicId) n++;
      }
      return n;
    }

    // ===============================
    // 6) STORAGE
    // ===============================
    function loadGame(){
      const raw = localStorage.getItem(STORE_GAME_KEY);
      if(raw){
        try{
          gameState = JSON.parse(raw);
          if(!gameState.groups) gameState = { groups:{} };
        }catch{
          gameState = { groups:{} };
        }
      }
    }

    function saveGame(){
      localStorage.setItem(STORE_GAME_KEY, JSON.stringify(gameState));
    }

    // ‚úÖ (BARU) simpan/ambil kelompok terpilih (hanya dari halaman TOPIK)
    function loadSelectedGroup(){
      selectedGroup = localStorage.getItem(STORE_SELECTED_GROUP_KEY) || null;
    }
    function saveSelectedGroup(){
      if(selectedGroup) localStorage.setItem(STORE_SELECTED_GROUP_KEY, selectedGroup);
      else localStorage.removeItem(STORE_SELECTED_GROUP_KEY);
    }

    // ===============================
    // 7) SESSION GURU
    // ===============================
    function loadTeacherSession(){
      isAdmin = localStorage.getItem(TEACHER_SESSION_KEY) === 'true';
    }
    function setTeacherSession(on){
      isAdmin = !!on;
      localStorage.setItem(TEACHER_SESSION_KEY, on ? 'true' : 'false');
    }
    function teacherLogout(){
      isAdmin = false;
      localStorage.removeItem(TEACHER_SESSION_KEY);
      showToast('üëã Logout berhasil');
      navigateTo('role');
    }


    function navigateTo(page, data=null){
      if(page === 'admin' && !isAdmin){
        showToast('Akses guru ditolak. Silakan login.');
        currentPage = 'role';
        renderPage();
        return;
      }

      currentPage = page;

      if(page === 'ranking'){
        rankFrom = (data && data.from) ? data.from : 'menu';
      }

      if(data && data.topic) selectedTopic = data.topic;
      if(data && data.group){
        selectedGroup = data.group;
        saveSelectedGroup();
      }
      // ‚úÖ tangkap box dari navigateTo
      if(data && data.box) selectedBox = data.box;

      renderPage();
      window.scrollTo({top:0, behavior:"smooth"});
    }

  function computeRanking(){
    const rows = [];

    for(const [groupName, g] of Object.entries(gameState.groups)){
      const pickedTopic = g.picked_topic;
      if(!pickedTopic) continue;

      const pickedBox = g?.topics?.[pickedTopic]?.picked_box || null;
      const caseEntry = pickedBox ? g?.topics?.[pickedTopic]?.cases?.[pickedBox] : null;

      const casesCorrect = (caseEntry && caseEntry.correct) ? 1 : 0;
      const totalTime = (caseEntry && caseEntry.correct) ? (caseEntry.time_taken || 0) : 0;

      rows.push({
        group: groupName,
        topicId: pickedTopic,
        topicName: topics.find(x=>x.id===pickedTopic)?.name || pickedTopic,
        progress: `${casesCorrect}/1`,
        casesCorrect,
        totalTime,
        last: g.last_updated || 0
      });
    }

    rows.sort((a,b)=>{
      if(b.casesCorrect !== a.casesCorrect) return b.casesCorrect - a.casesCorrect;
      if(a.totalTime !== b.totalTime) return a.totalTime - b.totalTime;
      return (b.last - a.last);
    });

    return rows;
  }

    // ===============================
    // 10) RENDER
    // ===============================
    function renderPage(){
      const app = document.getElementById('app');
      let content = '';

      if(currentPage === 'home'){
        content = `
          <section class="home">
            <div class="cloud" style="left: 8%; top: 10%; transform: scale(.85)"></div>
            <div class="cloud" style="left: 42%; top: 18%; transform: scale(.62)"></div>
            <div class="cloud" style="right: 8%; top: 8%; transform: scale(.95)"></div>

            <div class="container">
              <div class="hero">
                <div>
                  <div class="kicker">HALO .... SELAMAT DATANG DI</div>
                  <h1>ExcretiX</h1>
                  <button class="start btn" onclick="navigateTo('role')">MULAI</button>
                </div>

                <div class="hero-right">
                  <div class="cover-wrap">
                    <img class="cover-img" src="cover.png" alt="Cover ExcretiX">
                  </div>
                </div>

              </div>
            </div>
          </section>
        `;
      }

      else if(currentPage === 'role'){
        content = `
          <section class="page">
            <div class="cloud" style="left: 10%; top: 10%; transform: scale(.75)"></div>
            <div class="cloud" style="right: 10%; top: 14%; transform: scale(.9)"></div>

            <div class="container">
              <h1 class="page-title">PILIH AKSES</h1>

              <div class="panel" style="max-width:980px; margin:0 auto;">
                <div class="text-center" style="font-weight:900; color:rgba(31,59,40,.7); margin-bottom:16px;">
                  Login sebagai <b>Siswa</b> atau <b>Guru</b>.
                </div>

                <div class="menu-grid" style="grid-template-columns: repeat(2, minmax(0, 1fr));">
                  <div class="menu-card" onclick="navigateTo('menu')">
                    <div style="font-size:64px; margin-bottom:12px;">üßë‚Äçüéì</div>
                    <h3>SISWA</h3>
                    <p>Mulai petualangan, pilih topik, dan jawab tantangan.</p>
                    <button class="btn cta">MAIN</button>
                  </div>

                  <div class="menu-card" onclick="${isAdmin ? "navigateTo('admin')" : "showTeacherLogin()"}">
                    <div style="font-size:64px; margin-bottom:12px;">üë©‚Äçüè´</div>
                    <h3>GURU</h3>
                    <p>${isAdmin ? "Masuk ke dashboard guru." : "Masuk menggunakan akun guru."}</p>
                    <button class="btn cta">${isAdmin ? "MASUK" : "MASUK"}</button>
                  </div>
                </div>

                <div class="text-center" style="margin-top:18px;">
                  <button class="btn btn-pill btn-ghost" onclick="navigateTo('home')">BERANDA</button>
                </div>
              </div>
            </div>
          </section>
        `;
      }

      else if(currentPage === 'menu'){
        content = `
          <section class="page">
            <div class="container">
              <h1 class="page-title">MENU</h1>

              <div class="menu-grid">
                <div class="menu-card" onclick="navigateTo('rules')">
                  <h3>Petunjuk</h3>
                  <p>Petunjuk bermain agar petualanganmu lebih lancar.</p>
                  <button class="btn cta">DETAIL</button>
                </div>

                <div class="menu-card" onclick="navigateTo('topics')">
                  <h3>Topik</h3>
                  <p>Pilih topik ekskresi untuk tiap kelompok (1 topik per kelompok).</p>
                  <button class="btn cta">MAIN</button>
                </div>
                
                <div class="menu-card" onclick="navigateTo('maps')">
                  <h3>Peta</h3>
                  <p>Peta petunjuk untuk menemukan card permasalahan.</p>
                  <button class="btn cta">LIHAT</button>
                </div>

                <div class="menu-card" onclick="navigateTo('ranking',{from:'menu'})">
                  <h3>Peringkat</h3>
                  <p>Lihat peringkat live berdasarkan kasus benar & waktu.</p>
                  <button class="btn cta">LIHAT</button>
                </div>
              </div>

              <div class="home-back">
                <button class="btn btn-home" onclick="navigateTo('home')">BERANDA</button>
              </div>
            </div>
          </section>
        `;
      }

      else if(currentPage === 'rules'){
        content = `
          <section class="page">
            <div class="container">
              <h1 class="page-title">PETUNJUK</h1>

              <div class="panel" style="max-width:860px; margin:0 auto;">
                <div style="line-height:1.4; font-weight:400; color:rgba(31,59,40,.78);">
                  <p style="margin-bottom:16px;">
                    <b>Selamat datang di ExcretiX</b> üéÆ
                  </p>
                  <p style="margin-bottom:8px;">
                    <b> Langkah 1 - Bentuk Kelompok</b>
                  </p>
                  <p style="margin-bottom:2px;">
                    - Bentuk kelompok terlebih dahulu sesuai arahan guru.
                  </p>
                  <p style="margin-bottom:2px;">
                    - Diskusikan dan buat rencana investigasi (pembentukan ketua kelompok dan pembagian tugas) bersama anggota kelompokmu sebelum mulai bermain.
                  </p>
                  <p style="margin-bottom:8px; margin-top:12px;">
                    <b> Langkah 2 - Pilih Topik</b>
                  </p>
                  <p style="margin-bottom:4px;">
                    - Setelah itu, lanjutkan dengan memilih topik yang kamu sukai pada menu <b>Topik</b>.
                  </p>
                  <p style="margin-bottom:4px;">
                    - Ingat ya, satu kelompok hanya boleh memilih satu topik, misalnya "kelompok 1 Ginjal A". Jadi rencanakan dengan matang.
                  </p>
                  <p style="margin-bottom:8px; margin-top:12px;">
                    <b> Langkah 3 - Lihat Peta</b>
                  </p>
                  <p style="margin-bottom:4px;">
                    - Buka menu <b>Peta</b> untuk menemukan kartu kasus yang harus kalian selesaikan.
                  </p>
                  <p style="margin-bottom:4px;">
                    - Perhatikan keterangan pada kartu dan sesuaikan dengan topik yang dipilih agar tidak salah.
                  </p>
                  <p style="margin-bottom:8px; margin-top:12px;">
                    <b> Langkah 4 -  Selesaikan Kasus</b>
                  </p>
                  <p style="margin-bottom:4px;">
                    - Baca kasus pada kartu dengan teliti.
                  </p>
                  <p style="margin-bottom:4px;">
                    - Jawablah menggunakan kata kunci yang paling tepat sesuai permasalahan.
                  </p>
                  <p style="margin-bottom:4px;">
                    - Jika jawaban benar, kamu dapat melihat peringkat kelompok berdasarkan waktu dan ketepatan jawaban.
                  </p>
                  <p style="margin-bottom:8px; margin-top:12px;">
                    <b> Langkah 5 -  Lanjutkan Tahap Berikutnya</b>
                  </p>
                  <p style="margin-bottom:4px;">
                    - Jika kasus berhasil diselesaikan, lanjutkan ke tahap berikutnya.
                  </p>
                  <p style="margin-bottom:4px;">
                    - Cek LKPD yang dibawa oleh anggota kelompok.
                  </p>
                  <p style="margin-bottom:12px;">
                    - Anggota yang memegang LKPD akan melanjutkan kegiatan di kelas sesuai arahan guru.
                  </p>
                  <p style="margin-bottom:6px;">
                    <b>SEMANGAT!!!</b> üöÄ
                  </p>
                  <p style="margin-bottom:8px;">
                    Ingat! Waktu terus berjalan, jadi jangan sampai kehabisan waktu.
                  </p>
                  <div class="info-box">
                    üí° Tips: Semakin cepat dan tepat jawaban kelompokmu, semakin tinggi peringkat yang bisa kamu raih.
                  </div>
                </div>

                <div class="text-center" style="margin-top:18px;">
                  <button class="btn btn-pill btn-primary" onclick="navigateTo('menu')">MENU</button>
                </div>
              </div>
            </div>
          </section>
        `;
      }

      else if(currentPage === 'maps'){
        content = `
          <section class="page">
            <div class="container">
              <h1 class="page-title">Peta</h1>

              <div class="panel" style="max-width:980px; margin:0 auto;">
                <h2>Peta Petunjuk</h2>
                <div class="muted" style="margin-top:4px;">
                  Gunakan peta untuk menemukan kartu permasalahan (ExcretiX Card). Setelah itu, jawab di menu <b>Topik</b>.
                </div>

                <div class="map-image-wrap">
                  <img class="map-image" src= "peta.png" alt="Peta Petunjuk">
                </div>

                <div class="text-center" style="margin-top:18px;">
                  <button class="btn btn-pill btn-primary" onclick="navigateTo('menu')">MENU</button>
                  <button class="btn btn-pill btn-ghost" style="margin-left:10px;" onclick="navigateTo('topics')">TOPIK</button>
                </div>
              </div>
            </div>
          </section>
        `;
      }

      // ‚úÖ TOPICS: pilih kelompok dulu, lalu pilih 1 topik (terkunci)
      else if(currentPage === 'topics'){
        content = `
          <section class="page">
            <div class="container">
              <h1 class="page-title">TOPIK</h1>

              <div class="panel" style="max-width:980px;margin:0 auto;">
                <div class="form-group">
                  <label>Nama Kelompok</label>
                  <select id="topics_group_select" required onchange="handlePickGroupInTopics()">
                    <option value="" disabled ${!selectedGroup ? 'selected' : ''}>Pilih Kelompok...</option>
                    ${GROUP_OPTIONS.map(g => `
                      <option value="${escapeHtml(g)}" ${selectedGroup===g ? 'selected' : ''}>${escapeHtml(g)}</option>
                    `).join('')}
                  </select>
                </div>

                <div class="muted" style="text-align:center; margin-bottom:14px;">
                  Setiap kelompok hanya boleh memilih <b>1 topik</b>. 1 topik bisa dipilih maksimal <b>${MAX_GROUPS_PER_TOPIC}</b> kelompok.
                </div>

                <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:16px;">
                  ${topics.map(t=>{
                    const limit = TOPIC_GROUP_LIMITS[t.id] ?? MAX_GROUPS_PER_TOPIC;
                    const used = countGroupsPickingTopic(t.id);
                    const left = Math.max(0, limit - used);
                    const full = left === 0;


                    return `
                      <div class="menu-card" style="min-height:220px; opacity:${full?'.80':'1'}" onclick="startTopicForGroup('${t.id}')">
                        <div style="font-size:58px;margin-bottom:10px">${t.icon}</div>
                        <h3 style="margin-bottom:6px">${t.name}</h3>
                        <p style="margin-bottom:10px">Pilih topik ini untuk kelompok.</p>
                        <div class="muted" style="margin-bottom:12px; font-weight:900;">
                          Slot: <b>${used}/${limit}</b> ${full ? '‚Ä¢ (Penuh)' : `‚Ä¢ sisa ${left}`}
                        </div>
                        <button class="btn cta" data-topic-pick-btn="1" ${full ? 'disabled style="opacity:.6;cursor:not-allowed"' : ''}>Pilih</button>
                      </div>
                    `;
                  }).join('')}
                </div>

                <div class="text-center" style="margin-top:18px;">
                  <button class="btn btn-pill btn-primary" onclick="navigateTo('menu')">MENU</button>
                  <button class="btn btn-pill btn-ghost" style="margin-left:10px;" onclick="navigateTo('ranking',{from:'menu'})">PERINGKAT</button>
                </div>
              </div>
            </div>
          </section>
        `;
      }

      // ‚úÖ (BARU) CASES: pilih 1 kasus A/B/C setelah pilih topik
      else if(currentPage === 'cases'){
        const t = topics.find(x=>x.id===selectedTopic) || {name:'', icon:'üìå'};
        const casesDef = TOPIC_CASES[selectedTopic] || [];

        const g = selectedGroup ? gameState.groups[selectedGroup] : null;
        const pickedBox = g?.topics?.[selectedTopic]?.picked_box || null;

        content = `
          <section class="page">
             <div class="container">
             <h1 class="page-title">PILIH KASUS</h1>

            <div class="panel" style="max-width:980px;margin:0 auto;">
              <div class="text-center" style="margin-bottom:10px;">
              <div style="font-size:64px">${t.icon}</div>
              <div class="muted">
                Topik: <b>${escapeHtml(t.name)}</b> ‚Ä¢ Kelompok: <b>${escapeHtml(selectedGroup || '')}</b>
              </div>
            </div>

            <div class="info-box" style="margin-top:0;">
              ‚úÖ Setiap kelompok hanya boleh memilih <b>1 kasus</b> (A/B/C) dan <b>tidak bisa ganti</b>.
            </div>

            <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,260fr)); justify-content:center; gap:16px; margin-top:16px;">
              ${casesDef.map((c)=> {
                const locked = !!pickedBox && pickedBox !== c.id;
                const isChosen = pickedBox === c.id;

                return `
                  <div class="menu-card"
                      style="min-height:220px; opacity:${locked?'.75':'1'}"
                      onclick="${locked ? '' : `pickCaseForGroup('${c.id}')`}">
                    <div style="font-size:58px;margin-bottom:10px">üß©</div>
                    <h3 style="margin-bottom:6px">${escapeHtml(c.title)} (${escapeHtml(c.id)})</h3>
                    <p style="margin-bottom:10px">${isChosen ? '‚úÖ Sudah dipilih' : 'Pilih kasus ini untuk dikerjakan.'}</p>

                    <button class="btn cta" ${locked ? 'disabled style="opacity:.6;cursor:not-allowed"' : ''}>
                      ${isChosen ? 'Terpilih' : 'Pilih'}
                    </button>
                  </div>
                `;
              }).join('')}
            </div>

              <div class="text-center" style="margin-top:18px;">
                <button class="btn btn-pill btn-primary" onclick="navigateTo('topics')">TOPIK</button>
                <button class="btn btn-pill btn-ghost" style="margin-left:10px;" onclick="navigateTo('menu')">MENU</button>
              </div>
            </div>
          </div>
        </section>
      `;
    }

    else if(currentPage === 'answer'){
      const t = topics.find(x=>x.id===selectedTopic) || {name:'', icon:'üìå'};
      const rule = TOPIC_RULES?.[selectedTopic] || { boxes:{} };
      const casesDef = TOPIC_CASES[selectedTopic] || [];

      const g = selectedGroup ? gameState.groups[selectedGroup] : null;
      const pickedBox = g?.topics?.[selectedTopic]?.picked_box || selectedBox || null;

      // guard: kalau belum pilih A/B/C, arahkan ke halaman cases
      if(!pickedBox){
        setTimeout(()=>navigateTo('cases', { topic: selectedTopic, group: selectedGroup }), 0);
        content = `<section class="page"><div class="container"><div class="panel">Memuat...</div></div></section>`;
        app.innerHTML = content;
        return;
      }

      const casesData = g?.topics?.[selectedTopic]?.cases || {};
      const prev = casesData[pickedBox];
      const locked = !!(prev && prev.correct);
      const prevVal = prev?.answer || '';
      const attempts = prev?.attempts || 0;

      const boxMeta = casesDef.find(x=>x.id===pickedBox) || { id: pickedBox, title: `Textbox ${pickedBox}` };
      const boxRule = rule?.boxes?.[pickedBox];
      const minMatchText = boxRule?.minMatch ? `Minimal cocok: <b>${boxRule.minMatch}</b>` : '';

      content = `
        <section class="page">
          <div class="container">
            <h1 class="page-title">Topik: ${t.name}</h1>

            <div class="panel" style="max-width:980px; margin:0 auto;">
              <div class="text-center" style="margin-bottom:10px;">
                <div style="font-size:64px">${t.icon}</div>
                <div class="muted">
                  Kelompok: <b>${escapeHtml(selectedGroup || '')}</b> ‚Ä¢ Kasus dipilih: <b>${escapeHtml(pickedBox)}</b> ‚Ä¢ Progress: <b>${locked ? '1/1' : '0/1'}</b>
                </div>
              </div>

              <div class="info-box" style="margin-top:0;">
                üìù Sistem mengecek kata kunci sesuai kasus <b>${escapeHtml(pickedBox)}</b>. ${minMatchText ? `(${minMatchText})` : ''}
              </div>

              <div class="panel" style="margin-top:14px; background:rgba(255,255,255,.50);">
                <div class="flex-between">
                  <div style="font-weight:900; font-size:18px;">${escapeHtml(boxMeta.title)} (${escapeHtml(pickedBox)})</div>
                  <div class="muted">
                    ${locked
                      ? `‚úÖ Benar ‚Ä¢ Waktu: <b>${formatMs(prev.time_taken||0)}</b> ‚Ä¢ Percobaan: <b>${attempts}</b>`
                      : (attempts>0 ? `‚ùå Belum tepat ‚Ä¢ Percobaan: <b>${attempts}</b>` : `Belum dikerjakan`)
                    }
                  </div>
                </div>

                <div style="margin-top:12px;">
                  <textarea id="case_${escapeHtml(pickedBox)}" rows="6" placeholder="Tulis jawaban kasus ${escapeHtml(pickedBox)}..." ${locked?'disabled':''}>${escapeHtml(prevVal)}</textarea>
                  <div id="hint_${escapeHtml(pickedBox)}" class="hint"></div>
                </div>

                <div class="flex" style="margin-top:12px;">
                  <button class="btn btn-pill btn-primary" style="flex:1;" ${locked?'disabled style="flex:1;opacity:.6;cursor:not-allowed"':''}
                    onclick="submitSingleCase(event, '${pickedBox}')">
                    KOREKSI KASUS ${escapeHtml(pickedBox)}
                  </button>
                </div>
              </div>

              <div class="flex" style="margin-top:16px;">
                <button type="button" class="btn btn-pill btn-ghost" onclick="navigateTo('maps')" style="flex:1;">PETA</button>
                <button type="button" class="btn btn-pill btn-ghost" onclick="navigateTo('cases',{topic:'${selectedTopic}',group:'${escapeHtml(selectedGroup||'')}'})" style="flex:1;">KASUS</button>
                <button type="button" class="btn btn-pill btn-ghost" onclick="navigateTo('menu')" style="flex:1;">MENU</button>
              </div>
            </div>
          </div>
        </section>
      `;
    }

      else if(currentPage === 'ranking'){
        const rows = computeRanking();

        content = `
          <section class="page">
            <div class="container">
              <h1 class="page-title">RANK</h1>

              <div class="panel">
                ${rows.length === 0 ? `
                  <div class="text-center" style="padding:34px 0;">
                    <div style="font-size:56px;">üìä</div>
                    <div style="font-size:18px;font-weight:900;color:rgba(31,59,40,.75);margin-top:8px;">
                      Belum ada data. Mulai kerjakan topik!
                    </div>
                    <div style="margin-top:16px;">
                      <button class="btn btn-pill btn-primary" onclick="navigateTo('topics')">Mulai</button>
                    </div>
                  </div>
                ` : `
                  <div class="info-box" style="margin-top:0;">
                    üèÜ Urutan: <b>Kasus benar terbanyak</b> ‚Üí <b>Total waktu tercepat</b>
                  </div>

                  <div style="overflow:auto; margin-top:14px;">
                    <table>
                      <thead>
                        <tr>
                          <th style="width:110px;">Rank</th>
                          <th>Kelompok</th>
                          <th style="width:180px;">Topik</th>
                          <th style="width:160px;">Progress Kasus</th>
                          <th style="width:170px;">Total Waktu</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${rows.map((r, i) => {
                          const medal = i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'';
                          return `
                            <tr>
                              <td><b>${medal} ${i+1}</b></td>
                              <td style="font-weight:900;">${escapeHtml(r.group)}</td>
                              <td><b>${escapeHtml(r.topicName)}</b></td>
                              <td><b>${escapeHtml(r.progress)}</b></td>
                              <td><b>${formatMs(r.totalTime)}</b></td>
                            </tr>
                          `;
                        }).join('')}
                      </tbody>
                    </table>
                  </div>

                  <div class="text-center" style="margin-top:18px;">
                    ${
                      rankFrom === 'answer'
                        ? `
                          <!-- ‚úÖ (REVISI) dari answer: lanjut kasus berikutnya / selesai -->
                          <button class="btn btn-pill btn-primary" onclick="continueAfterRank()">
                            ${afterRankAction?.isDone ? 'SELESAI ‚Üí MENU' : 'LANJUT KASUS BERIKUTNYA'}
                          </button>
                          <button class="btn btn-pill btn-ghost" style="margin-left:10px;" onclick="navigateTo('menu')">‚Üê Menu</button>
                        `
                        : `
                          <button class="btn btn-pill btn-primary" onclick="navigateTo('menu')">MENU</button>
                        `
                    }
                  </div>
                `}
              </div>
            </div>
          </section>
        `;
      }

      else if(currentPage === 'admin'){
        const rows = computeRanking();

        content = `
          <section class="page">
            <div class="container">
              <div class="flex-between" style="margin-bottom:14px;">
                <h1 class="page-title" style="margin:0;">DASHBOARD GURU</h1>

                <div class="flex" style="justify-content:flex-end;">
                  <button class="btn btn-pill btn-ghost" onclick="downloadExcel()" title="Download Excel">‚¨áÔ∏è Excel</button>
                  <button class="btn btn-pill btn-danger" onclick="resetAllData()" title="Reset semua data">üîÑ Reset</button>
                  <button class="btn btn-pill btn-danger" onclick="teacherLogout()">üö™ Logout</button>
                </div>
              </div>

              <div class="panel">
                <h2 style="margin-bottom:6px;">Data Kelompok</h2>
                <div class="muted" style="margin-bottom:14px;">Menampilkan progres kasus & jawaban per kelompok.</div>

                ${Object.keys(gameState.groups || {}).length === 0 ? `
                  <div class="text-center" style="padding:34px 0;">
                    <div style="font-size:56px;">üìù</div>
                    <div style="font-size:18px;font-weight:900;color:rgba(31,59,40,.75);margin-top:8px;">
                      Belum ada jawaban masuk.
                    </div>
                  </div>
                ` : `
                  <div style="overflow:auto;">
                    <table>
                      <thead>
                        <tr>
                          <th style="width:90px;">Rank</th>
                          <th>Kelompok</th>
                          <th style="width:180px;">Topik</th>
                          <th style="width:160px;">Progress Kasus</th>
                          <th style="width:140px;">Total Waktu</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${rows.map((r,i)=>`
                          <tr>
                            <td><b>${i+1}</b></td>
                            <td style="font-weight:900;">${escapeHtml(r.group)}</td>
                            <td><b>${escapeHtml(r.topicName)}</b></td>
                            <td><b>${escapeHtml(r.progress)}</b></td>
                            <td><b>${formatMs(r.totalTime)}</b></td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>

                  <div style="margin-top:18px;">
                    ${Object.entries(gameState.groups || {}).map(([groupName, g])=>{
                      const picked = g.picked_topic;
                      const topicMeta = topics.find(x=>x.id===picked);
                      const topicName = topicMeta?.name || (picked || 'Belum pilih');
                      const icon = topicMeta?.icon || 'üìå';

                      const casesDef = picked ? (TOPIC_CASES[picked] || []) : [];
                      const casesData = picked ? (g.topics?.[picked]?.cases || {}) : {};

                      const correctCount = casesDef.filter(c => casesData[c.id]?.correct).length;
                      const progress = picked ? `${correctCount}/${casesDef.length}` : `0/0`;

                      return `
                        <div class="panel" style="margin-top:14px; background:rgba(255,255,255,.50);">
                          <div class="flex-between">
                            <div style="font-weight:900; font-size:18px;">${escapeHtml(groupName)}</div>
                            <div class="muted">Topik: <b>${escapeHtml(topicName)}</b> ‚Ä¢ Progress: <b>${escapeHtml(progress)}</b> ‚Ä¢ Waktu: ${formatMs(g.total_time || 0)}</div>
                          </div>

                          ${!picked ? `
                            <div class="info-box" style="margin-top:12px;">Kelompok ini belum memilih topik.</div>
                          ` : `
                            <div style="margin-top:12px; display:grid; grid-template-columns:repeat(auto-fit, minmax(240px, 1fr)); gap:12px;">
                              ${casesDef.map((c, idx)=>{
                                const entry = casesData[c.id];
                                if(!entry){
                                  return `
                                    <div style="border:2px solid rgba(47,90,58,.14); border-radius:18px; padding:12px; background:rgba(232,246,230,.65);">
                                      <div style="font-weight:900;">${icon} ${escapeHtml(topicName)} ‚Ä¢ Kasus ${idx+1}</div>
                                      <div class="muted" style="margin-top:6px;">Belum dikerjakan</div>
                                    </div>
                                  `;
                                }
                                return `
                                  <div style="border:2px solid rgba(47,90,58,.14); border-radius:18px; padding:12px; background:rgba(232,246,230,.65);">
                                    <div style="font-weight:900;">${icon} ${escapeHtml(topicName)} ‚Ä¢ Kasus ${idx+1}</div>
                                    <div class="muted" style="margin-top:6px;">
                                      Status: <b>${entry.correct ? '‚úÖ Benar' : '‚ùå Salah'}</b>
                                      ‚Ä¢ Percobaan: <b>${entry.attempts || 1}</b>
                                      ‚Ä¢ Waktu: <b>${formatMs(entry.time_taken || 0)}</b>
                                    </div>
                                    <div style="margin-top:10px; background:rgba(255,255,255,.65); border-radius:14px; padding:10px; border:2px solid rgba(47,90,58,.10); line-height:1.6;">
                                      ${escapeHtml(entry.answer || '').replace(/\n/g,'<br>')}
                                    </div>
                                  </div>
                                `;
                              }).join('')}
                            </div>
                          `}
                        </div>
                      `;
                    }).join('')}
                  </div>
                `}
              </div>
            </div>
          </section>
        `;
      }

      app.innerHTML = content;

      // ‚úÖ (BARU) kalau page topics: kunci tombol pilih kalau belum pilih kelompok
      if(currentPage === 'topics'){
        updateTopicsCardsLock();
      }
    }

    // ‚úÖ (BARU) handle pilihan kelompok di halaman TOPIK + lock tombol
    function handlePickGroupInTopics(){
      const sel = document.getElementById('topics_group_select');
      const groupName = (sel?.value || '').trim();
      selectedGroup = groupName || null;
      saveSelectedGroup();
      updateTopicsCardsLock();
    }

    function updateTopicsCardsLock(){
      const hasGroup = !!(selectedGroup && selectedGroup.trim());
      document.querySelectorAll('[data-topic-pick-btn="1"]').forEach(btn=>{
        // jika topik sudah penuh, biarkan disabled (sudah di-render)
        const alreadyDisabledBecauseFull = btn.disabled && btn.style.cursor === 'not-allowed';
        if(!alreadyDisabledBecauseFull){
          btn.disabled = !hasGroup;
        }
        btn.style.opacity = btn.disabled ? '.55' : '1';
        btn.style.cursor = btn.disabled ? 'not-allowed' : 'pointer';
      });
    }

    // ===============================
    // 11) DATA MODEL (GROUP + TOPIK TERKUNCI)
    // ===============================
    function ensureGroupExists(groupName){
      if(!gameState.groups[groupName]){
        gameState.groups[groupName] = {
          picked_topic: null,
          topics: {},
          total_correct: 0,
          total_time: 0,
          last_updated: Date.now()
        };
      }
      if(!gameState.groups[groupName].topics) gameState.groups[groupName].topics = {};
      return gameState.groups[groupName];
    }

    // ‚úÖ pilih topik untuk kelompok (terkunci)
    function startTopicForGroup(topicId){
      const groupName = (selectedGroup || '').trim();
      if(!groupName){
        showToast('Pilih kelompok terlebih dahulu.');
        return;
      }

      const g = ensureGroupExists(groupName);

      if(g.picked_topic && g.picked_topic !== topicId){
        const tName = topics.find(x=>x.id===g.picked_topic)?.name || g.picked_topic;
        showToast(`Kelompok ini sudah memilih topik: ${tName}. Tidak bisa ganti.`);
        return;
      }

      const limit = TOPIC_GROUP_LIMITS[topicId] ?? MAX_GROUPS_PER_TOPIC;
      const usedCount = countGroupsPickingTopic(topicId);
      const alreadyThisTopic = (g.picked_topic === topicId);

      if(!alreadyThisTopic && usedCount >= limit){
        const tName = topics.find(x=>x.id===topicId)?.name || topicId;
        showToast(`Topik "${tName}" sudah penuh (maks ${limit} kelompok). Pilih topik lain.`);
        return;
      }

      g.picked_topic = topicId;

      // init topic container
      if(!g.topics[topicId]) g.topics[topicId] = { cases:{} };
      if(!g.topics[topicId].cases) g.topics[topicId].cases = {};

      g.last_updated = Date.now();
      saveGame();

      navigateTo('cases', { topic: topicId, group: groupName });
    }

    function pickCaseForGroup(boxId){
      const groupName = (selectedGroup || '').trim();
      if(!groupName){
        showToast('Pilih kelompok terlebih dahulu.');
        navigateTo('topics');
        return;
      }

      const g = ensureGroupExists(groupName);

      if(!g.picked_topic){
        showToast('Pilih topik terlebih dahulu.');
        navigateTo('topics');
        return;
      }

      const topicId = g.picked_topic;

      if(!g.topics[topicId]) g.topics[topicId] = { cases:{} };
      if(!g.topics[topicId].cases) g.topics[topicId].cases = {};

      // ‚úÖ terkunci: tidak boleh ganti box
      const already = g.topics[topicId].picked_box;
      if(already && already !== boxId){
        showToast(`Kelompok ini sudah memilih kasus ${already}. Tidak bisa ganti.`);
        return;
      }

      g.topics[topicId].picked_box = boxId;
      g.last_updated = Date.now();
      saveGame();

      selectedTopic = topicId;
      selectedBox = boxId;

      navigateTo('answer', { topic: topicId, group: groupName, box: boxId });
    }

    async function submitSingleCase(event, caseId){
      event?.preventDefault?.();

      if(!selectedGroup){
        showToast('Kelompok belum dipilih.');
        navigateTo('topics');
        return;
      }

      const groupName = String(selectedGroup).trim();
      const g = ensureGroupExists(groupName);

      if(g.picked_topic && g.picked_topic !== selectedTopic){
        showToast('Topik tidak sesuai pilihan kelompok.');
        navigateTo('topics');
        return;
      }

      const casesDef = TOPIC_CASES[selectedTopic] || [];
      const cIndex = casesDef.findIndex(x => x.id === caseId);
      if(cIndex < 0){
        showToast('Kasus tidak valid.');
        return;
      }

      if(!g.topics[selectedTopic]) g.topics[selectedTopic] = { cases:{} };
      if(!g.topics[selectedTopic].cases) g.topics[selectedTopic].cases = {};

      const casesData = g.topics[selectedTopic].cases;

      const prev = casesData[caseId];
      if(prev && prev.correct){
        showToast('Kasus ini sudah benar. Tidak bisa dijawab ulang.');
        renderPage();
        return;
      }

      const el = document.getElementById(`case_${caseId}`);
      const ans = (el?.value || '').trim();
      if(!ans){
        showToast('Jawaban masih kosong.');
        return;
      }

      // start time per kasus (biar waktu dihitung sejak mulai buka topik, dan makin cepat makin bagus)
      if(!casesData[caseId]) casesData[caseId] = {};
      if(!casesData[caseId].startedAt) casesData[caseId].startedAt = Date.now();

      const attempts = (prev?.attempts || 0) + 1;

      // ‚úÖ (REVISI) sekarang evaluasi pakai topic + caseId
      const res = evaluateAnswer(selectedTopic, caseId, ans);

      if(res.ok){
        const timeTaken = Date.now() - (casesData[caseId].startedAt || Date.now());

        casesData[caseId] = {
          correct: true,
          attempts,
          answer: ans,
          matched: res.matched,
          time_taken: timeTaken,
          timestamp: Date.now(),
          startedAt: casesData[caseId].startedAt
        };

        // update total (untuk ranking live)
        const correctCount = casesDef.filter(c => casesData[c.id]?.correct).length;
        const timeSum = casesDef.reduce((s,c)=> s + (casesData[c.id]?.time_taken || 0), 0);

        g.total_correct = correctCount;
        g.total_time = timeSum;
        g.last_updated = Date.now();
        saveGame();

        await sendToSheet({
          token: SHEET_TOKEN,
          group: groupName,
          topicId: selectedTopic,
          topicName: topics.find(x=>x.id===selectedTopic)?.name || selectedTopic,
          boxId: caseId,
          correct: true,
          attempts,
          timeTakenMs: timeTaken,
          answer: ans,
          matched: res.matched || [],
          userAgent: navigator.userAgent
        });

        const hint = document.getElementById(`hint_${caseId}`);
        if(hint){
          hint.className = 'hint ok';
          hint.innerHTML = `‚úÖ <b>Benar!</b> Kata kunci: <b>${escapeHtml(res.matched.slice(0,6).join(', '))}${res.matched.length>6?'...':''}</b>.`;
        }

        // ‚úÖ (BARU) tentukan kasus berikutnya untuk tombol di Rank
        const nextDef = casesDef[cIndex + 1];
        afterRankAction = {
          topic: selectedTopic,
          group: groupName,
          nextCaseId: null,
          isDone: true
};

        showToast(`‚úÖ Kasus ${cIndex+1} benar! Masuk Rank...`);
        setTimeout(()=>navigateTo('ranking', { from:'answer' }), 700);
        return;
      }

      // salah
      casesData[caseId] = {
        ...(prev || {}),
        correct: false,
        attempts,
        answer: ans,
        timestamp: Date.now(),
        startedAt: casesData[caseId].startedAt || Date.now()
      };

      g.last_updated = Date.now();
      saveGame();

      const hint = document.getElementById(`hint_${caseId}`);
      if(hint){
        hint.className = 'hint bad';
        hint.innerHTML = `‚ùå <b>Belum tepat.</b> Kurang <b>${res.needed}</b> kata kunci lagi. (Percobaan: <b>${attempts}</b>)`;
      }

      showToast('Jawaban belum tepat, coba lagi.');
      renderPage();
    }

    // ‚úÖ (BARU) lanjut setelah halaman rank: ke kasus berikutnya / selesai ke menu
    function continueAfterRank(){
      if(!afterRankAction){
        navigateTo('menu');
        return;
      }

      const { topic, group, nextCaseId, isDone } = afterRankAction;

      if(isDone){
        afterRankAction = null;
        showToast('‚úÖ Semua kasus selesai!');
        navigateTo('menu');
        return;
      }

      navigateTo('answer', { topic, group });

      setTimeout(()=>{
        const ta = document.getElementById(`case_${nextCaseId}`);
        if(ta){
          ta.scrollIntoView({ behavior:'smooth', block:'center' });
          ta.focus();
        }
      }, 80);

      afterRankAction = null;
    }

    // ===============================
    // 12) LOGIN GURU (modal)
    // ===============================
    function showTeacherLogin(){
      if(isAdmin){
        navigateTo('admin');
        return;
      }

      const backdrop = document.createElement('div');
      backdrop.className = 'modal-backdrop';
      backdrop.id = 'teacherModal';

      backdrop.innerHTML = `
        <div class="modal">
          <div class="icon">üë©‚Äçüè´</div>
          <div class="title">Login Guru</div>

          <div style="margin-top:16px;">
            <div style="margin-bottom:12px;">
              <label>Username</label>
              <input id="teacherUsername" type="text" placeholder="Masukkan username" autocomplete="off" />
            </div>

            <div style="margin-bottom:8px;">
              <label>Password</label>
              <input id="teacherPassword" type="password" placeholder="Masukkan password" />
            </div>

            <div id="loginError" style="display:none; margin:10px 0; font-weight:900; color:#ef4444; text-align:center;">
              ‚ùå Username atau password salah!
            </div>

            <div class="flex" style="margin-top:12px;">
              <button class="btn btn-pill btn-primary" type="button" onclick="handleTeacherLogin()" style="flex:1;">Login</button>
              <button class="btn btn-pill btn-ghost" type="button" onclick="closeTeacherModal()" style="flex:1;">Batal</button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(backdrop);
      document.body.style.overflow = 'hidden';

      backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) closeTeacherModal(); });
      backdrop.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter'){ e.preventDefault(); handleTeacherLogin(); }
        if(e.key === 'Escape'){ closeTeacherModal(); }
      });

      setTimeout(()=>document.getElementById('teacherUsername')?.focus(), 0);
    }

    function closeTeacherModal(){
      document.getElementById('teacherModal')?.remove();
      document.body.style.overflow = '';
    }

    function handleTeacherLogin(){
      const u = (document.getElementById('teacherUsername')?.value || '').trim();
      const p = (document.getElementById('teacherPassword')?.value || '');
      const err = document.getElementById('loginError');

      if(u === TEACHER_USERNAME && p === TEACHER_PASSWORD){
        setTeacherSession(true);
        closeTeacherModal();
        showToast('‚úÖ Login guru berhasil');
        navigateTo('admin');
      }else{
        if(err) err.style.display = 'block';
        const pEl = document.getElementById('teacherPassword');
        if(pEl) pEl.value = '';
        pEl?.focus();
        setTimeout(()=>{ if(err) err.style.display='none'; }, 2000);
      }
    }

    async function resetAllData(){
      if(!isAdmin){
        showToast('Akses ditolak.');
        return;
      }

      const ok = confirm('Yakin reset semua data siswa? Semua hasil akan terhapus.');
      if(!ok) return;

      // 1) minta server set resetAt baru
      const resp = await sendToSheet({
        token: SHEET_TOKEN,
        action: "reset"
      });

      if(!resp.ok){
        showToast("‚ùå Reset gagal: " + (resp.error || "unknown"));
        return;
      }

      // 2) reset lokal guru juga
      localStorage.removeItem(STORE_GAME_KEY);
      localStorage.removeItem(STORE_SELECTED_GROUP_KEY);
      gameState = { groups: {} };

      // 3) simpan resetAt baru (biar device guru juga langsung aman)
      if(resp.resetAt){
        localStorage.setItem(STORE_RESET_AT_KEY, String(resp.resetAt));
      }

      showToast('‚úÖ Reset global berhasil');
      navigateTo('role');
    }

    function downloadExcel(){
      if(!isAdmin){
        showToast('Akses ditolak.');
        return;
      }

      if(typeof XLSX === 'undefined'){
        alert('Library Excel (XLSX) belum termuat. Pastikan script CDN xlsx sudah ditambahkan.');
        return;
      }

      const rowsRanking = computeRanking();

      // Sheet 1: Ranking (live)
      const sheet1 = [];
      sheet1.push(['Rank','Kelompok','Topik','Progress Kasus','Total Waktu (detik)']);
      rowsRanking.forEach((r, i)=>{
        sheet1.push([
          i+1,
          r.group,
          r.topicName,
          r.progress,
          Math.round((r.totalTime||0)/1000)
        ]);
      });

      // Sheet 2: Jawaban per kasus
      const sheet2 = [];
      sheet2.push([
        'Kelompok','Topik','Kasus','Status','Percobaan','Waktu (detik)','Jawaban','Kata Kunci Terdeteksi','Timestamp'
      ]);

      for(const [groupName, g] of Object.entries(gameState.groups || {})){
        const picked = g.picked_topic;
        const topicMeta = topics.find(x=>x.id===picked);
        const topicName = topicMeta?.name || (picked || '');

        if(!picked){
          sheet2.push([groupName,'(belum pilih)','', '', '', '', '', '', '']);
          continue;
        }

        const casesDef = TOPIC_CASES[picked] || [];
        const casesData = g.topics?.[picked]?.cases || {};

        const pickedBox = g?.topics?.[picked]?.picked_box || '';
        const entry = pickedBox ? (g.topics?.[picked]?.cases?.[pickedBox] || null) : null;

        if(!pickedBox){
          sheet2.push([groupName, topicName, '(belum pilih kasus)', '', '', '', '', '', '']);
        } else if(!entry){
          sheet2.push([groupName, topicName, `Kasus ${pickedBox}`, 'Belum dikerjakan', '', '', '', '', '']);
        } else {
          sheet2.push([
            groupName,
            topicName,
            `Kasus ${pickedBox}`,
            entry.correct ? 'Benar' : 'Salah',
            entry.attempts || 0,
            entry.time_taken ? Math.round(entry.time_taken/1000) : '',
            entry.answer || '',
            (entry.matched || []).join(', '),
            entry.timestamp ? new Date(entry.timestamp).toLocaleString('id-ID') : ''
          ]);
        }
      }

      const wb = XLSX.utils.book_new();
      const ws1 = XLSX.utils.aoa_to_sheet(sheet1);
      const ws2 = XLSX.utils.aoa_to_sheet(sheet2);

      ws1['!cols'] = [{wch:8},{wch:18},{wch:16},{wch:14},{wch:18}];
      ws2['!cols'] = [
        {wch:18},{wch:14},{wch:10},{wch:14},{wch:10},{wch:12},{wch:60},{wch:30},{wch:22}
      ];

      XLSX.utils.book_append_sheet(wb, ws1, 'Ranking');
      XLSX.utils.book_append_sheet(wb, ws2, 'Jawaban');

      const filename = `ExcretiX_Hasil_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, filename);
      showToast('‚¨áÔ∏è Excel berhasil dibuat');
    }

    loadTeacherSession();
    loadGame();
    loadSelectedGroup();
    syncFromSheet();      // ‚úÖ ambil data pusat dari sheet
    renderPage();

    setInterval(syncFromSheet, 5000); // ‚úÖ refresh tiap 5 detik

  </script>
</body>
</html>
